## Несоответствия требованиям

### Критичные

-   ~~**Нет единого json-описания версии (schema v2) как единственного источника правды**~~ ✅ Реализован `scripts/version.py create`, документация и UX переведены на `versions/<id>.json`, lock v1 объявлены устаревшими.
-   ~~**Переизбыточное кэширование custom nodes**~~ ✅ Все кеши завязаны на `COMFY_CACHE_ROOT` (`models`, `custom_nodes`, `comfy`, `resolved`).
-   ~~**Установка зависимостей и моделей каждый раз заново**~~ ✅ ядро и кастом-ноды берутся из кеша по SHA; модели линкуются из общего каталога.
-   ~~**Модели кэшируются в нескольких каталогах**~~ ✅ `verify_models.py` использует те же функции кеша, что и resolver; остались только пути из `COMFY_CACHE_ROOT`.
-   **Нет команды/скрипта для запуска UI по версии**: Требование — «запустить версию с ui». В репо есть `run_handler_local.sh` (headless handler), но нет сценария `run_ui <version>` или документации, как поднять UI из spec без ручных шагов.
-   **Нет простого сценария запуска handler по версии без ручных аргументов**: Handler требует `--workflow`, `--version-id`. Требование подразумевает «запустить версию через handler» из json (без ручного указания путей). Нужен high-level wrapper (например `scripts/run_version_handler.py --version <id>`). Сейчас нет команды, которая принимает только версию.

### Высокие

-   **Отсутствует операция «проверить версию»**: Требование — «ее можно проверить, запустить, удалить, клонировать». Проверка (`version validate/test`) не реализована для schema v2. Есть `scripts/verify_models.py`, но он работает с lock-файлом и требует отдельных аргументов.
-   **Удаление версии**: Нет поддержки удаления по schema v2 (`versions/<id>.json`). Требуется реализация команды `version delete`.
-   **Клонирование/реализация версии**: Есть `scripts/realize_version.py`, но оно не гарантирует экономию места (см. кэширование). Требуется реализация клонирования для schema v2.
-   ~~**Сложное создание версии**~~ ✅ `scripts/version.py create` принимает repo/nodes/models, автоматически резолвит commit и checksum.
-   ~~**Несогласованная документация**~~ ✅ обновлены `docs/` (manual, instructions, cheatsheets, tech, runpod, smoketest, todo).

### Средние

-   **Избыточные окружения `.venv`**: Скрипты создают отдельные venv внутри каждой версии (`realize_from_resolved`). Требование — версии переиспользуют зависимые ресурсы. Нужно понять, допустимо ли единое venv/кэш wheel или лёгкая пересборка (уточнить у пользователя).
-   **Параллельное хранение моделей**: помимо главного кеша, модели копируются/линкуются в `COMFY_HOME/models`, что может дублировать место (при отсутствии симлинков). Проверить, что `ensure_link_from_cache` всегда делает symlink, иначе будет идти копирование.
-   **Нет явной операции «удалить/клонировать» для моделей/нод**: Требование «удалить, клонировать» версию подразумевает UX-команды. В текущем CLI нет упрощённых команд, только низкоуровневые скрипты.
-   **Handler зависит от GCS по умолчанию**: Пользователь ожидал простого использования без доп.параметров. `rp_handler/output.py` ориентирован на GCS, нужен fallback на локальный путь из версии.

### Низкие/наблюдения

-   ~~**Лишние инструменты для lock v1**~~ ✅ Старые скрипты (`scripts/clone_version.sh`, `create_version.py`, `lockfiles/`) удалены, комментарии обновлены.
-   **Тесты ориентированы на старые сценарии** (`tests/test_main.py` и др. используют schema v1).
-   **Куча RunPod-специфичных путей**: `/workspace/custom_nodes/workspace`, `/runpod-volume`, которые могут быть не нужны при едином кэше. ➡️ Обновить документацию/конфиги на дефолты `/workspace/ComfyUI` + явное указание для volume.

## План работ

1. **Архитектура хранения версий** ✅

    - Schema v2 — единственный формат, lock v1 объявлены устаревшими.
    - Генератор spec реализован (`scripts/version.py create`).

2. **Единые кеши** ✅

    - Все кеши завязаны на `COMFY_CACHE_ROOT` (модели, ноды, ядро, resolved-lock).

3. **Реализация версии** ✅

    - `realize_from_resolved` использует кеш ядра/нод; модели связываются символическими ссылками из общего каталога.

4. **Команды UX**

    - Создать CLI `scripts/version.py` (или расширить существующий) с подкомандами: `create`, `validate`, `realize`, `run-ui`, `run-handler`, `delete`, `clone`.
    - `run-ui <version>` поднимает `ComfyUI/main.py` с нужными путями (headless/with UI флаг).
    - `run-handler <version> --workflow X` использует минимальные параметры.
    - `validate <version>` проверяет наличие в кэше и целостность моделей/нод.
    - `delete <version>` удаляет реализацию, но не трогает общий кеш.

5. **Документация** ✅

    - Обновлены ключевые разделы (`manual`, `instructions`, cheatsheets, `tech`, `runpod`, `smoketest`, `todo`).

6. **Тестирование**

    - Переписать автотесты под schema v2 (unit для resolver, CLI smoke).
    - (По требованию пользователя тесты не писать прямо сейчас, но запланировать в будущем).

7. **Чистка устаревшего**
    - ~~Удалить `lockfiles/`, `scripts/*` для schema v1~~ ✅ Удалены `lockfiles/`, старые скрипты (`clone_version.sh`, `create_version.py`); обновлены комментарии.
    - Привести `requirements.txt`, `pyproject.toml` в соответствие с обновлённой архитектурой.

## Вопросы

-   Нужно ли хранить единую копию `ComfyUI` (репозиторий) для всех версий? Допустима ли структура `cache/comfy/<sha>`?
    можно не хватить, оно ставится с гита по sha - это ок
-   Требуется ли обязательный headless запуск UI, или нужно обеспечить полноценный web UI с портом/конфигом? Нужен ли systemd/nohup сценарий?
    требуется оба и ui и headless (serverless api)
    systemd/nohup - не знаю что такое
-   Следует ли предусмотреть полное отсутствие интернета (offline): как тогда пополняются кеши (ручная загрузка)?
    без интернета - ни чго работать не должно, это нормально. оффлайн режим не нужен!
-   Какой формат предпочтителен для `versions/<id>.json`: нужно ли хранить checksum моделей внутри spec?
    да `versions/<id>.json` - ок
    хранить checksum моделей - можно но не обязательно. можно просто по ссылке кешить. Да там может измениться - но это не страшно
-   Какие ограничения по размеру диска/структуре каталога на RunPod (например, `~/` недоступен)?
    работаем в корне runpod-volume
