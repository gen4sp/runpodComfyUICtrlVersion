## Несоответствия требованиям

### Критичные

-   **Нет единого json-описания версии (schema v2) как единственного источника правды**: присутствуют устаревшие lock-файлы (`lockfiles/comfy-*.lock.json`), а актуальная логика оперирует `versions/<id>.json`. Требование — «просто есть json с описанием версии», без ручного выбора lock. Сейчас `scripts/create_version.py` генерирует отдельный lock и не поддерживает schema v2. Нужно унифицировать.
-   **Переизбыточное кэширование custom nodes**: `rp_handler.resolver._nodes_cache_root()` создаёт и использует кэш `~/.comfy-cache/custom_nodes` и RunPod-специфичный путь. Требование: «кешом является единственная папка с моделями (или нодами в случае нод)». Нужно оставить один конфигурируемый каталог и исключить дополнительные локации.
-   **Установка зависимостей и моделей каждый раз заново**: `realize_from_resolved` клонирует репозитории в целевой `COMFY_HOME` и создаёт симлинки из node-cache, но не использует общий «единожды скачанный» кеш для ComfyUI core. Команды `clone_version.sh`/`realize_version.py` требуют `git clone` при каждом развёртывании. Нужно ввести общий cache для ComfyUI core и нод с переиспользованием по commit.
-   **Модели кэшируются в нескольких каталогах**: `scripts/verify_models.py` использует `_cache_root()` (env + несколько fallback путей). Требование — единая папка. Сейчас поведение не гарантирует один путь (возможна авто-подстановка `~/.comfy-cache/models`, `/runpod-volume/cache/models`, `/workspace/models-cache`).
-   **Нет команды/скрипта для запуска UI по версии**: Требование — «запустить версию с ui». В репо есть `run_handler_local.sh` (headless handler), но нет сценария `run_ui <version>` или документации, как поднять UI из spec без ручных шагов.
-   **Нет простого сценария запуска handler по версии без ручных аргументов**: Handler требует `--workflow`, `--version-id`. Требование подразумевает «запустить версию через handler» из json (без ручного указания путей). Нужен high-level wrapper (например `scripts/run_version_handler.py --version <id>`). Сейчас нет команды, которая принимает только версию.

### Высокие

-   **Отсутствует операция «проверить версию»**: Требование — «ее можно проверить, запустить, удалить, клонировать». Проверка (`version validate/test`) не реализована для schema v2. Есть `scripts/verify_models.py`, но он работает с lock-файлом и требует отдельных аргументов.
-   **Удаление версии**: `scripts/remove_version.sh` ориентирован на старую структуру с lock-файлами. Нет поддержки удаления по schema v2 (`versions/<id>.json`).
-   **Клонирование/реализация версии**: Есть `scripts/realize_version.py`, но оно не гарантирует экономию места (см. кэширование). Команда `clone_version.sh` использует lock-файлы schema v1 и не соответствует текущей архитектуре.
-   **Сложное создание версии**: `scripts/create_version.py` создаёт lock v1 и требует множество опций (`--comfy-path`, `--venv`, `--models-spec`). Нет утилиты создания spec v2 из простого ввода (core repo + список нод/моделей) с автоматическим резолвом commit.
-   **Несогласованная документация**: `docs/manual.md`, `docs/instructions.md` описывают lock-файлы, много шагов с ручными параметрами. Нету «простого использования» в духе: `versions/<id>.json` → `scripts/version realize <id>` → UI/handler.

### Средние

-   **Избыточные окружения `.venv`**: Скрипты создают отдельные venv внутри каждой версии (`realize_from_resolved`). Требование — версии переиспользуют зависимые ресурсы. Нужно понять, допустимо ли единое venv/кэш wheel или лёгкая пересборка (уточнить у пользователя).
-   **Параллельное хранение моделей**: помимо главного кеша, модели копируются/линкуются в `COMFY_HOME/models`, что может дублировать место (при отсутствии симлинков). Проверить, что `ensure_link_from_cache` всегда делает symlink, иначе будет идти копирование.
-   **Нет явной операции «удалить/клонировать» для моделей/нод**: Требование «удалить, клонировать» версию подразумевает UX-команды. В текущем CLI нет упрощённых команд, только низкоуровневые скрипты.
-   **Handler зависит от GCS по умолчанию**: Пользователь ожидал простого использования без доп.параметров. `rp_handler/output.py` ориентирован на GCS, нужен fallback на локальный путь из версии.

### Низкие/наблюдения

-   **Лишние инструменты для lock v1** (`scripts/clone_version.sh`, `create_version.py`, `lockfiles/`), создают путаницу.
-   **Тесты ориентированы на старые сценарии** (`tests/test_main.py` и др. используют schema v1).
-   **Куча RunPod-специфичных путей**: `/workspace/custom_nodes/workspace`, `/runpod-volume`, которые могут быть не нужны при едином кэше.

## План работ

1. **Архитектура хранения версий**

    - Разработать schema v2 как единственный формат (вероятно уже частично реализовано в `versions/<id>.json`), удалить/депрекейтить lock v1.
    - Создать генератор spec: `scripts/version create --repo --nodes --models` с авто резолвом commit и модельных checksum.

2. **Единые кеши**

    - Определить один каталог для моделей (например `$COMFY_CACHE/models`) с конфигурируемым путём.
    - Аналогично для кастом-нод (`$COMFY_CACHE/custom_nodes`). Переписать `_nodes_cache_root` и `_cache_root`.
    - Добавить кеш для ComfyUI core (по commit SHA) с симлинками/rsync в версии.

3. **Реализация версии**

    - Обновить `realize_from_resolved`: использовать кэшированные репозитории (core и ноды), избегать полных клонов.
    - Обеспечить симлинки моделей из общего кеша без дубликатов.
    - Убедиться, что Python-зависимости также кэшируются (возможно, pip cache/wheels каталоги).

4. **Команды UX**

    - Создать CLI `scripts/version.py` (или расширить существующий) с подкомандами: `create`, `validate`, `realize`, `run-ui`, `run-handler`, `delete`, `clone`.
    - `run-ui <version>` поднимает `ComfyUI/main.py` с нужными путями (headless/with UI флаг).
    - `run-handler <version> --workflow X` использует минимальные параметры.
    - `validate <version>` проверяет наличие в кэше и целостность моделей/нод.
    - `delete <version>` удаляет реализацию, но не трогает общий кеш.

5. **Документация**

    - Обновить `docs/manual.md`, `docs/instructions.md` на простой сценарий: «создал spec → проверил → запустил UI/handler → удалил».
    - Добавить раздел про структуру кэша и экономию места.

6. **Тестирование**

    - Переписать автотесты под schema v2 (unit для resolver, CLI smoke).
    - (По требованию пользователя тесты не писать прямо сейчас, но запланировать в будущем).

7. **Чистка устаревшего**
    - Удалить `lockfiles/`, `scripts/*` для schema v1 или пометить deprecated.
    - Привести `requirements.txt`, `pyproject.toml` в соответствие с обновлённой архитектурой.

## Вопросы

-   Нужно ли хранить единую копию `ComfyUI` (репозиторий) для всех версий? Допустима ли структура `cache/comfy/<sha>`?
-   Требуется ли обязательный headless запуск UI, или нужно обеспечить полноценный web UI с портом/конфигом? Нужен ли systemd/nohup сценарий?
-   Следует ли предусмотреть полное отсутствие интернета (offline): как тогда пополняются кеши (ручная загрузка)?
-   Какой формат предпочтителен для `versions/<id>.json`: нужно ли хранить checksum моделей внутри spec?
-   Какие ограничения по размеру диска/структуре каталога на RunPod (например, `~/` недоступен)?
