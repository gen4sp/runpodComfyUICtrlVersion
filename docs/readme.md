## RunPod ComfyUI Version Control

Набор хелперов и скриптов для воспроизводимого управления версиями ComfyUI на RunPod (volume) и в serverless-окружениях. Цель — быстро собирать, фиксировать и запускать конкретные версии ComfyUI (ядро, кастом-узлы, зависимости, модели) локально и в контейнере, с детерминированными окружениями.

### Ключевые возможности

-   **Версионирование с lock-файлами**: фиксация репозиториев и кастом-узлов по SHA, зависимостей `pip` по точным версиям и артефактов моделей по checksum для детерминированных сборок.
-   **Быстрые операции с версиями**: создать версию, клонировать/удалить версию, переключаться между версиями.
-   **Docker + handler**: контейнер с хендлером для запуска воркфлоу под конкретную версию. Поддерживает реальное выполнение ComfyUI в headless режиме. Возврат результата как **ссылка на артефакт в Google Cloud Storage (по умолчанию)** или **base64**.
-   **Локальная проверка**: сценарии и инструкции для запуска и тестирования на macOS и в Docker перед публикацией на RunPod.
-   **Загрузка моделей**: верификатор поддерживает источники `http(s)`, `file`, `gs://`, `hf://` (Hugging Face через токен `HF_TOKEN`) и `civitai://` (Civitai через токен `CIVITAI_TOKEN`).

### Happy path

-   Инициализировать ComfyUI в рабочем каталоге/на RunPod volume.
-   Создать версию: зафиксировать кастом-узлы, зависимости venv, модели, коммиты (SHA).
-   Реализовать/клонировать версию: развернуть из `versions/<id>.json` с отдельным `.venv`.
-   Собрать Docker-образ с handler, передать воркфлоу и выбранную версию для запуска.
-   Получить результат: base64 или ссылку GCS.

### Почему lock-файлы

Lock-файл — это единый источник правды о версии. В нем закрепляются:

-   **ComfyUI core**: источник и точный `commit SHA`.
-   **Custom Nodes**: список репозиториев и их `commit SHA`.
-   **Python-зависимости**: точные версии и/или ссылки на колёса/артефакты (включая `torch*` для нужного CUDA/CPU профиля).
-   **Модели/ресурсы**: источники, хэши (checksum) и назначение путей.

Это позволяет воспроизводить окружение без «дрейфа» зависимостей и узлов.

### Требования

-   macOS (для локальной разработки) и/или RunPod среда с volume.
-   Docker (для сборки и локального тестирования handler).
-   Python 3.11+ и `venv` (для локальной работы скриптов).
-   Доступ к Google Cloud Storage (если нужен вывод в GCS).

### Быстрый старт

1. Подготовка окружения

    - Клонируйте репозиторий.
    - Установите Docker и Python 3.11+.
    - Подготовьте переменные окружения для GCS при необходимости (см. `instructions.md`).

2. Инициализация ComfyUI

    - Запустите скрипт инициализации (см. `instructions.md`). Он развернет ComfyUI, настроит `venv`, установит базовые зависимости.

3. Создание версии (lock)

    - Выполните команду создания версии (см. `instructions.md`).
    - Будет сгенерирован lock-файл с SHA, pinned зависимостями и описанием моделей.

4. Клонирование/удаление версии

    - Клонируйте версию в новое рабочее место или удалите ненужную.

5. Сборка и запуск Docker handler
    - Соберите образ и запустите handler, передав воркфлоу и выбранную версию.
    - Результат вернется как base64 или ссылка GCS.

### Документация

-   `tech.md` — структура каталогов и назначение файлов/скриптов.
-   `instructions.md` — руководство по использованию и параметрам (обновлено: реализация версии из JSON, Docker/handler, локальный запуск, GCS по умолчанию, репродукция/регрессия).
-   `todo.md` — поэтапный план работ и локальное тестирование.
-   `runpod.md` — гид по запуску в RunPod (Pods/serverless), переменные окружения, smoke-тест.

### Ссылки и исследования

-   Заметки/исследования по теме: `https://chatgpt.com/share/68d164b1-a9e8-800b-9800-86f91239c9fa`

### Статус

-   Lock-файлы: beta (пинование по SHA/версиям предусмотрено архитектурой и будет расширяться).

### Лицензия

Будет добавлена позже.
