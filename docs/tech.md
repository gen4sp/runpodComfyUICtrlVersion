## Технический обзор и структура проекта

Цель: обеспечить воспроизводимое управление версиями ComfyUI для RunPod (volume/serverless) и локальных запусков, с фиксацией зависимостей/узлов по SHA (lock-файлы, beta) и удобными сценариями сборки и тестирования.

### Общая структура каталогов

Предлагаемая структура (часть папок появится по мере реализации скриптов):

-   `scripts/`
    -   Скрипты автоматизации: инициализация, создание/клонирование/удаление версии, сборка образов, локальные проверки.
-   `versions/`
    -   Материалы конкретных версий: ссылки на lock-файлы, метаданные, экспортируемые артефакты.
-   `lockfiles/`
    -   Lock-файлы версий. Каждый lock-файл описывает:
        -   Источник ComfyUI и `commit SHA`;
        -   Список кастом-узлов (репо + `commit SHA`);
        -   Python-зависимости (pinned версии, опционально wheel URLs);
        -   Модели/ресурсы (источники, checksum, целевые пути);
        -   Системные параметры (версия Python, опции компоновки).
-   `docker/`
    -   Dockerfile(ы), entrypoint, runtime-конфиги, handler (серверless/CLI входная точка).
-   `workflows/`
    -   Шаблоны и примеры воркфлоу ComfyUI (JSON/graph), используемые handler.
-   `models/`
    -   Описание источников моделей (не сами модели). Скачивание выполняется скриптами согласно lock-файлам.
-   `docs/`
    -   Дополнительная документация, диаграммы, примеры конфигов.

Корневые файлы:

-   `readme.md` — обзор, быстрый старт, ссылки.
-   `tech.md` — этот документ, техническое устройство.
-   `todo.md` — пошаговый план реализации и тестирования.
-   `instructions.md` — руководство пользователя.

### Ключевые артефакты

-   Lock-файл (например, `lockfiles/comfy-<version>.lock.json`):

    -   `comfyui`: { `repo`, `commit` }
    -   `custom_nodes`: [{ `name`, `repo`, `commit` }]
    -   `python`: { `version`, `interpreter`, `packages`: [{ `name`, `version` | `url` }] }
    -   `models`: [{ `name`, `source?`, `checksum?`, `target_path` }]
    -   `runtime`: { `env`, `cuda`, `extras` }

Примечания по детерминизму:

-   Скрипт генерации не пишет метаданные времени.
-   Списки сортируются по стабильным ключам (имя пакета/узла/модели).
-   Пути в моделях сохраняются в «сыром» виде (могут содержать `$COMFY_HOME`),
    при вычислении `checksum` локально производится экспансия переменных окружения.

-   Handler:
    -   Принимает: путь/описание воркфлоу, имя версии/lock-файл, параметры вывода.
    -   Возвращает: base64-результат или ссылку в GCS.
    -   Встраивается в Docker и может работать локально.

### Скрипты (план)

В каталоге `scripts/` планируются следующие утилиты:

-   `init_comfyui.sh` — развертывание ComfyUI, базовая структура, создание `venv`.
-   `create_version.py` — генерация lock-файла: сбор SHA, зависимостей, моделей.
-   `clone_version.sh` — разворачивание окружения по lock-файлу в новую директорию.
-   `remove_version.sh` — удаление версии (чистка каталогов/метаданных).
-   `build_docker.sh` — сборка Docker-образа с handler.
-   `run_handler_local.sh` — локальный запуск handler с воркфлоу и выбранной версией.
-   `verify_models.py` — проверка наличия/хэшей моделей по lock-файлу, скачивание недостающих.
-   `pin_requirements.py` — пиновка зависимостей в формат lock-файла (включая URLs колес, если нужно).

### Docker и handler

-   `docker/Dockerfile`

    -   Базовый образ с Python, системными зависимостями для ComfyUI и CUDA (если требуется).
    -   Копирование handler и скриптов.
    -   Валидация lock-файла в build/run стадиях.

-   `docker/handler/`
    -   `main.py` — CLI/серверная точка входа.
    -   `output.py` — код возврата результата (base64 / GCS upload).
    -   `resolver.py` — применение lock-файла (установка зависимостей, узлов, моделей).

### GCS интеграция

-   Поддерживаются переменные окружения для аутентификации и указания bucket.
-   При локальной отладке можно переключить вывод на base64/локальный файл.

### Тестирование (высокоуровнево)

-   Локальные проверки на macOS: init → create_version → verify_models → run_handler_local.
-   Docker-проверка: build_docker → run handler → сравнение вывода с эталоном.
-   Репродукция: на основе одного lock-файла собрать окружение дважды и сравнить SHA установленных узлов и хэши моделей.

### Ограничения и статус

-   Lock-файлы: beta. Поддержка пиновки по SHA/версиям уже закладывается, будет расширяться.
