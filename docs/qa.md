# Вопросы по единой спецификации версий и кешированию

Ниже — критичные вопросы, ответы на которые определят архитектуру и интерфейсы. Пожалуйста, ответьте кратко по пунктам, чтобы я мог подготовить точный план переделки.

## 1) Формат единой спецификации в `versions/*.json`

1.1. Подтвердите желаемую структура полей (минимум):

-   `comfy`: `{ repo, ref, commit? }`
-   `custom_nodes`: список `{ repo, ref?, commit?, path? }`
-   `models`: список `{ name?, source, checksum?, target_subdir? }`
-   `env?`: произвольные переменные окружения (например пути)
-   `options?`: флаги (offline, skip_models и т.п.)

Нужно ли добавить поле `workflows?` (дефолтные файлы/скрипты для smoke‑test)?
ОТВЕТ: ок, подходит. workflows - не нужно

## 2) Пиннинг источников (детерминизм)

2.1. Для репозиториев (ComfyUI и кастом‑ноды) — достаточно ли указывать `ref` (branch/tag) и автоматически фиксировать `commit` при первом разрешении?
ОТВЕТ: нужна ссылка и опциональный реф

2.2. Куда сохранять «разрешённый» результат (лок):

-   a) обратно в `versions/*.json` (модифицировать файл);
-   b) в отдельный артефакт: `~/.comfy-cache/resolved/<version_id>.lock.json` (рекомендуется);
-   c) иное место?
    ОТВЕТ: b

## 3) Глобальные кеши и переиспользование

3.1. Подтвердите расположение по умолчанию:

-   модели: `/runpod-volume/cache/models` (переменная `COMFY_CACHE_MODELS`)
-   кастом‑ноды: `/runpod-volume/cache/custom_nodes` (переменная `COMFY_CACHE_NODES`)
    ОТВЕТ: $MODELS_DIR (env) по умолчанию $COMFY_HOME/models. Кастом‑ноды: кеш `/workspace/custom_nodes/workspace` (если смонтирован) или `~/.comfy-cache/custom_nodes`, в версию — symlink в `$COMFY_HOME/ComfyUI/custom_nodes`3.2. Принимаем ли дедупликацию по`sha256`(для моделей) и по`commit SHA`(для нод)?
ОТВЕТ:как лучше
3.3. Разрешены ли символические ссылки из кеша в`COMFY_HOME`? (Linux/RunPod — да; иные окружения?)
    ОТВЕТ:да

## 4) Контроль целостности моделей

4.1. Требовать обязательный `checksum` в спецификации или можно вычислять при первой загрузке?
ОТВЕТ:не обязательно, делаем как проще

4.2. Если источник меняется (тот же URL, другое содержимое) —

-   a) всегда считать ошибкой при несовпадении хеша;
-   b) допускать обновление при флаге `--refresh`;
-   c) другое?
    ОТВЕТ: ссылка является ключом к кешу, не нужно проверять чексумму

## 5) Конфликты версий кастом‑нод

5.1. Если разные версии требуют разные `commit` одного и того же репо — держим несколько копий в кеше (`<repo>@<commit>`) и линкуем нужную? (предпочтительно)
ОТВЕТ: да
5.2. Нужно ли поддерживать локальные модификации кастом‑нод (dirty‑репо) или всегда «чистые» коммиты?
ОТВЕТ: всегда чистые

## 6) Зависимости кастом‑нод (pip)

6.1. Устанавливаем зависимости строго в отдельный venv на версию (`COMFY_HOME/.venv`), без общего системного кеша? (рекомендуется для изоляции)
ОТВЕТ: да
6.2. Допускать ли общие wheels‑кеши (`--find-links /wheels`) для ускорения?
ОТВЕТ: да
6.3. Принимать ли `requirements.txt`/`pyproject.toml` из нод автоматически и объединять в единый план установки?
ОТВЕТ: видимо стоит да

## 7) Поведение `rp_handler`

7.1. Можно ли заменить вход `--lock` на `--version-id/--spec` (handler сам резолвит, подтягивает кеши, линкует и запускает)?
ОТВЕТ: в хендлер передается воркфлоу и айди версии которую надо загрузить. Старт версии максимально быстрый. (Реализовано)
7.2. Оставляем ли обратную совместимость с `--lock` (или убираем совсем)?
ОТВЕТ: обратная совместимость убрана. (Реализовано)

## 8) Поведение `version.py realize`

8.1. Должен ли он уметь принимать напрямую `--version-id` новой схемы и полностью обходиться без старых lock‑файлов?
ОТВЕТ: да
8.2. Нужен ли режим `--dry-run` с печатью плана (какие репо/модели будут скачаны/ссылки созданы)?
ОТВЕТ: да (реализовано)

## 9) Offline и политика фолбеков

9.1. В offline‑режиме — падать, если артефакт не найден в кеше, или допускать частичные загрузки?
ОТВЕТ: допускаем
9.2. Переменные для токенов (HF/Civitai) подтверждаете:

-   `HF_TOKEN`, `CIVITAI_TOKEN`?
    ОТВЕТ: подтвверждаю

## 10) Очистка и квоты кеша

10.1. Нужен ли встроенный `gc` (по TTL/размеру) или ручная очистка скриптом?
ОТВЕТ: не нужен
10.2. Нужны ли метрики/отчёты об использовании кеша?
ОТВЕТ: нет

## 11) Схема и миграции

11.1. Вводим `schema_version` для `versions/*.json`? (рекомендуется)
ОТВЕТ: ок
11.2. Разрешаете удалить текущие `lockfiles/*` из основной документации (оставив поддержку чтения как deprecated путь)?
ОТВЕТ: удаляем

## 12) Мульти‑файловые модели и группы

12.1. Нужна ли поддержка групп артефактов (несколько файлов под одним логическим именем модели)? Формат, например:

```json
{ "name": "wan2.2-t2v-14b", "files": [ {"source": "hf://...", "checksum": "..."}, ... ], "target_subdir": "unet" }
```

ОТВЕТ: думаю нет смысла

12.2. Допускать ли шаблоны/глоб для набора файлов из HF репозитория?
ОТВЕТ: нет, не усложняем

## 13) Дополнительные поля спецификации

13.1. Нужен ли раздел `workflows` (имена файлов и параметры для smoke‑tests)?
ОТВЕТ:нет
13.2. Нужен ли раздел `mounts`/`paths` для внешних путей моделей?
ОТВЕТ: нет

## 14) Стандартизация путей

14.1. Базовые дефолты подтверждаете?

-   `COMFY_HOME`: `/runpod-volume/comfy-<version_id>`
-   `MODELS_DIR` внутри `COMFY_HOME` + ссылки из глобального кеша
-   Глобальные кеши в `/runpod-volume/cache/*`
    ОТВЕТ: ок, но кеш для моделей не нужен. В том смысле что они один раз скачиваются и все, если не скачено - скачиваем, если скачено - используем. Не дублируем.

## 15) Symlink vs копирование

15.1. Разрешаем «только symlink» (быстро и экономно) или иногда копируем (флаг/опция)?
ОТВЕТ: модели всегда используем из одного места. Используем `extra_model_paths.yaml` по необходимости. Кастом‑ноды — symlink из кеша.

## 16) Логи и трассировка

16.1. Нужен ли единый журнал разрешений/загрузок в `~/.comfy-cache/logs/*.log`?
ОТВЕТ: нет

## 17) Инкрементальные обновления версий

17.1. Допускаем ли «поверх» существующей версии обновлять только изменившиеся ссылки (re‑resolve)? Если да — как фиксировать это: новый `resolved lock` или перезапись существующего?
ОТВЕТ: перезапись

## 18) Требования к UX

18.1. Ожидаете ли CLI‑команды высокого уровня:

-   `version resolve <id>` — разрешить и зафиксировать (без запуска)
-   `version realize <id>` — развернуть окружение
-   `version test <id>` — прогнать smoke‑workflow
-   `handler run --version-id <id> --workflow <wf>` — исполнение
    ОТВЕТ: да

---

Пожалуйста, подтвердите/уточните пункты. После ваших ответов подготовлю детальный план работ в `docs/todo.md` и последовательность миграции.
