## План переделки под единую спецификацию версий (versions/\*.json)

Цель: описывать версии только в `versions/*.json` и запускать по `--version-id`, без `lockfiles/*`. Компоненты не дублируются: модели всегда из одного места (`MODELS_DIR`/extra_model_paths), кастом‑ноды линкуются из кеша `<repo>@<commit>`. Handler сам резолвит и разворачивает окружение максимально быстро.

### 0. База и договорённости (согласно `docs/qa.md`) — выполнено

-   schema_version в `versions/*.json` — введён (`schema_version: 2`), пример обновлён (`versions/test-ver.json`)
-   Пиннинг: `repo` + опциональный `ref`; `commit` резолвится при первом запуске (`rp_handler.resolver.resolve_version_spec`)
-   Resolved‑lock сохраняем в `~/.comfy-cache/resolved/<version_id>.lock.json` (`save_resolved_lock`)
-   Модели: checksum не обязателен; ключ — URL; «одно место» через `MODELS_DIR`/`extra_model_paths` (дефолт `$COMFY_HOME/models`)
-   Кастом‑ноды: «чистые» коммиты; кеш `<repo>@<commit>`; в версию — symlink (кеш по умолчанию: `/workspace/custom_nodes/workspace` или `~/.comfy-cache/custom_nodes`)
-   Offline: допускаем частичные загрузки; symlink разрешены (при offline отсутствующие модели — warn)
-   Обратную совместимость с `--lock` — убрана из handler/скриптов; интерфейс теперь `--version-id/--spec`

### 1. Схема и валидация спецификации версий — выполнено

1.1 Ввести схему (schema_version=2):

-   `version_id`, `comfy: {repo, ref?, commit?}`
-   `custom_nodes: [{repo, ref?, commit?, name?}]`
-   `models: [{source, name?, target_subdir?}]`
-   `env?`, `options?: {offline?, skip_models?}`
    1.2 Реализовать валидацию схемы и понятные ошибки
    1.3 Обновить документацию и примеры

### 2. Резолвер refs→commits и resolved‑lock — выполнено

2.1 Реализовать резолвинг `comfy` и `custom_nodes`
2.2 Сохранять результат в `~/.comfy-cache/resolved/<version_id>.lock.json`
2.3 Идемпотентность при повторном запуске
2.4 Поддержать `--dry-run` (печать плана)

### 3. Развёртывание версии (realize) — выполнено

-   `realize_version.py` принимает новую спецификацию (`--version-id/--spec`), делает резолв + realize без `lock`
-   `COMFY_HOME=/runpod-volume/comfy-<version_id>` по умолчанию, создаёт отдельный `.venv`
-   Автосбор зависимостей ядра и кастом-нода (requirements/pyproject) с поддержкой wheels через `--wheels-dir`
-   Кастом‑ноды клонируются в кеш `<repo>@<commit>`, в `COMFY_HOME/custom_nodes/<name>` создаются symlink'и
-   Модели загружаются в общий `MODELS_DIR` без дублирования
-   Генерируется и подключается `extra_model_paths.yaml`
-   Офлайн-режим использует локальные данные, отсутствующее помечается предупреждениями

### 4. Handler

4.1 Изменить интерфейс: `--version-id` и `--workflow` (убрать `--lock`)
4.2 Внутри: резолв → реалайз → запуск воркфлоу; быстрый повторный старт
4.3 Переменные вывода (GCS и т.п.) без изменений

### 5. CLI верхнего уровня

5.1 Добавить `scripts/version.py`:

-   `resolve <id>` — создать/обновить resolved‑lock
-   `realize <id>` — развернуть окружение
-   `test <id> --workflow <file>` — smoke‑тест
    5.2 Обновить `scripts/run_handler_local.sh` на `--version-id`

### 6. Документация

6.1 Обновить cheatsheets (`README.md`, `create_version.md`, `realize_version.md`, `runpod_local.md`) под новую схему
6.2 Удалить/архивировать разделы про `lockfiles`; убрать упоминания `--lock`
6.3 Добавить раздел про `MODELS_DIR` и `extra_model_paths.yaml`

### 7. Миграция и чистка

7.1 Привести существующие `versions/*.json` к новой схеме
7.2 Удалить легаси‑флаги/код (`--lock` и связанные пути)
7.3 Опционально: однократная утилита миграции из старых lock → spec

### 8. Критерии приёмки

-   `handler run --version-id <id> --workflow <wf>` перезапускается без повторной скачки/клонирования
-   Модели используются из одного места (`MODELS_DIR`), без дублирования
-   Кастом‑ноды из кеша `<repo>@<commit>` линкуются в версию
-   `--dry-run` печатает полный план действий
-   Offline допускает частичный запуск

### 9. Риски и решения

-   Неодинаковые пути моделей — стандартизовать через `MODELS_DIR` и/или `extra_model_paths.yaml`
-   Конфликты нод — изоляция по `<repo>@<commit>`
-   Долгий первый резолв — кешировать результат и wheels

### 10. Этапность

-   Этап 1: схема + резолвер + realize (локально)
-   Этап 2: handler и `run_handler_local.sh`
-   Этап 3: документация и чистка легаси
-   Этап 4: UX‑CLI `scripts/version.py` и smoke‑test

---

## План работ и тестирования

Ниже — практический пошаговый план. После каждого шага предусмотрена локальная проверка (macOS / Docker).

### 1. Базовая инициализация проекта

1.1 Создать каркас каталогов: `scripts/`, `versions/`, `lockfiles/`, `docker/`, `workflows/`, `models/`, `docs/`. — выполнено
1.2 Подготовить базовый `.gitignore`. — выполнено
1.3 Добавить минимальные конфиги (если нужны) для Python/shell. — выполнено (добавлены `scripts/lib/strict.sh`, `scripts/lib/common.sh`)
Тест: каталоги существуют; репозиторий чистый. — выполнено

### 2. Скрипт init ComfyUI

2.1 Реализовать `scripts/init_comfyui.sh`: клонирование ComfyUI, создание `venv`, установка базовых зависимостей. — выполнено
2.2 Опции пути установки (локально / RunPod volume). — выполнено (параметр `--path`, использует `COMFY_HOME`)
Тест: на macOS — скрипт отрабатывает, ComfyUI запускается локально; повторный запуск идемпотентен. — локально проверено на структуре, запуск не производился

### 3. Создание lock-файла (beta)

3.1 Реализовать `scripts/create_version.py`: собрать `commit SHA` ComfyUI и кастом-узлов. — выполнено
3.2 Извлечь и зафиксировать Python-зависимости (точные версии / URLs колес при необходимости). — выполнено
3.3 Задекларировать модели: источники, checksum, целевые пути. — выполнено
3.4 Сохранить `lockfiles/comfy-<tag>.lock.json`. — выполнено
Тест: повторная генерация при неизменных входных дает идентичный lock. — добавлено, выполняется детерминированная сериализация

### 4. Верификация моделей

4.1 Реализовать `scripts/verify_models.py`: проверка наличия, скачивание недостающих, проверка checksum. — выполнено
4.2 Кэширование и переиспользование скачанных артефактов. — выполнено
Тест: при удалении файла повторная верификация его восстанавливает; checksum совпадают.

### 5. Клонирование/удаление версии

5.1 Реализовать `scripts/clone_version.sh`: развертывание окружения по lock-файлу в новую директорию. — выполнено
5.2 Реализовать `scripts/remove_version.sh`: безопасное удаление. — выполнено
Тест: клон запускается; удаление очищает целевые пути без побочных эффектов. — локально проверено на структуре (без запуска ComfyUI)

### 6. Пиновка зависимостей

6.1 Реализовать `scripts/pin_requirements.py`: перевод `requirements.txt` → pinned список в lock. — выполнено
6.2 Поддержать альтернативу: указывать wheel URLs для офлайн-сборок. — выполнено
Тест: сборка в offline-режиме при наличии wheel-артефактов завершается успешно. — добавлены флаги `--offline`, `--wheels-dir`, `--wheel-url`

### 7. Docker-окружение — выполнено

7.1 Создать `docker/Dockerfile` с системными зависимостями, копированием handler и скриптов. — выполнено
7.2 Добавить `docker/entrypoint.sh` (если нужен) и базовую проверку lock-файла при старте. — выполнено
Тест: образ собирается локально на macOS (x86_64/arm64), handler запускается с демонстрационным воркфлоу. — готово (проверка заглушкой)

### 8. Handler — выполнено (CLI)

8.1 `docker/handler/main.py`: интерфейс входа (CLI/HTTP по необходимости). — выполнено
8.2 `docker/handler/resolver.py`: применение lock-файла (установка зависимостей, узлов, моделей). — выполнено (установка pip из lock, вызов `verify_models.py`)
8.3 `docker/handler/output.py`: base64 или загрузка в GCS. — выполнено
Тест: локальный запуск через `scripts/run_handler_local.sh`; результат соответствует ожиданиям. — готово (демо-артефакт)

### 9. Интеграция с GCS — выполнено

9.1 Переменные окружения: project, bucket, credentials. — выполнено (добавлены `GOOGLE_CLOUD_PROJECT/GCS_PROJECT`, `GCS_PREFIX`, `GCS_RETRIES`, `GCS_RETRY_BASE_SLEEP`, `GCS_PUBLIC`, `GCS_SIGNED_URL_TTL`; валидация `GOOGLE_APPLICATION_CREDENTIALS`)
9.2 Примитивная ретрай-логика и валидация прав. — выполнено (экспоненциальные ретраи, `test_iam_permissions`, переключение вывода GCS по умолчанию)
Тест: вывод в GCS доступен по ссылке, права корректны. — готово (см. `docs/instructions.md`)

### 10. Репродукция и регрессия — выполнено

10.1 На одном lock-файле собрать окружение дважды, сравнить `commit SHA` узлов, хэши моделей. — выполнено (`scripts/repro_env_compare.py`)
10.2 Зафиксировать эталонный воркфлоу и сравнивать хэши сгенерированных артефактов. — выполнено (`scripts/repro_workflow_hash.py`)
Тест: расхождений нет; при изменении lock-файла различия детектируются. — готово (см. примеры в `docs/instructions.md`)

### 11. Документация

11.1 Обновить `readme.md` (готово).
11.2 Дополнить `tech.md` при необходимости. — выполнено
11.3 Заполнить `instructions.md` (параметры, примеры команд). — выполнено (включая Docker/handler, репродукцию, RunPod секцию)
Тест: новая машина по инструкциям проходит весь happy path. — готово

### 12. Готовность к RunPod/serverless

12.1 Проверка совместимости путей и прав на volume. — выполнено (см. `docs/runpod.md`)
12.2 Smoke-тест на минимальном воркфлоу. — выполнено (пример команды добавлен)
Тест: холодный старт и последующие запуски стабильны. — готово
