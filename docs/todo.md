## План работ и тестирования

Ниже — практический пошаговый план. После каждого шага предусмотрена локальная проверка (macOS / Docker).

### 1. Базовая инициализация проекта

1.1 Создать каркас каталогов: `scripts/`, `versions/`, `lockfiles/`, `docker/`, `workflows/`, `models/`, `docs/`. — выполнено
1.2 Подготовить базовый `.gitignore`. — выполнено
1.3 Добавить минимальные конфиги (если нужны) для Python/shell. — выполнено (добавлены `scripts/lib/strict.sh`, `scripts/lib/common.sh`)
Тест: каталоги существуют; репозиторий чистый. — выполнено

### 2. Скрипт init ComfyUI

2.1 Реализовать `scripts/init_comfyui.sh`: клонирование ComfyUI, создание `venv`, установка базовых зависимостей. — выполнено
2.2 Опции пути установки (локально / RunPod volume). — выполнено (параметр `--path`, использует `COMFY_HOME`)
Тест: на macOS — скрипт отрабатывает, ComfyUI запускается локально; повторный запуск идемпотентен. — локально проверено на структуре, запуск не производился

### 3. Создание lock-файла (beta)

3.1 Реализовать `scripts/create_version.py`: собрать `commit SHA` ComfyUI и кастом-узлов. — выполнено
3.2 Извлечь и зафиксировать Python-зависимости (точные версии / URLs колес при необходимости). — выполнено
3.3 Задекларировать модели: источники, checksum, целевые пути. — выполнено
3.4 Сохранить `lockfiles/comfy-<tag>.lock.json`. — выполнено
Тест: повторная генерация при неизменных входных дает идентичный lock. — добавлено, выполняется детерминированная сериализация

### 4. Верификация моделей

4.1 Реализовать `scripts/verify_models.py`: проверка наличия, скачивание недостающих, проверка checksum. — выполнено
4.2 Кэширование и переиспользование скачанных артефактов. — выполнено
Тест: при удалении файла повторная верификация его восстанавливает; checksum совпадают.

### 5. Клонирование/удаление версии

5.1 Реализовать `scripts/clone_version.sh`: развертывание окружения по lock-файлу в новую директорию.
5.2 Реализовать `scripts/remove_version.sh`: безопасное удаление.
Тест: клон запускается; удаление очищает целевые пути без побочных эффектов.

### 6. Пиновка зависимостей

6.1 Реализовать `scripts/pin_requirements.py`: перевод `requirements.txt` → pinned список в lock.
6.2 Поддержать альтернативу: указывать wheel URLs для офлайн-сборок.
Тест: сборка в offline-режиме при наличии wheel-артефактов завершается успешно.

### 7. Docker-окружение

7.1 Создать `docker/Dockerfile` с системными зависимостями, копированием handler и скриптов.
7.2 Добавить `docker/entrypoint.sh` (если нужен) и базовую проверку lock-файла при старте.
Тест: образ собирается локально на macOS (x86_64/arm64), handler запускается с демонстрационным воркфлоу.

### 8. Handler

8.1 `docker/handler/main.py`: интерфейс входа (CLI/HTTP по необходимости).
8.2 `docker/handler/resolver.py`: применение lock-файла (установка зависимостей, узлов, моделей).
8.3 `docker/handler/output.py`: base64 или загрузка в GCS.
Тест: локальный запуск через `scripts/run_handler_local.sh`; результат соответствует ожиданиям.

### 9. Интеграция с GCS

9.1 Переменные окружения: project, bucket, credentials.
9.2 Примитивная ретрай-логика и валидация прав.
Тест: вывод в GCS доступен по ссылке, права корректны.

### 10. Репродукция и регрессия

10.1 На одном lock-файле собрать окружение дважды, сравнить `commit SHA` узлов, хэши моделей.
10.2 Зафиксировать эталонный воркфлоу и сравнивать хэши сгенерированных артефактов.
Тест: расхождений нет; при изменении lock-файла различия детектируются.

### 11. Документация

11.1 Обновить `readme.md` (готово).
11.2 Дополнить `tech.md` при необходимости.
11.3 Заполнить `instructions.md` (параметры, примеры команд). — выполнено (раздел init)
Тест: новая машина по инструкциям проходит весь happy path.

### 12. Готовность к RunPod/serverless

12.1 Проверка совместимости путей и прав на volume.
12.2 Smoke-тест на минимальном воркфлоу.
Тест: холодный старт и последующие запуски стабильны.
